name: Test nginx Configuration

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'config/nginx.conf'
      - 'tests/**'
      - '.github/workflows/test-nginx.yml'
  pull_request:
    paths:
      - 'config/nginx.conf'
      - 'tests/**'
      - '.github/workflows/test-nginx.yml'

jobs:
  validate-syntax:
    name: Validate nginx Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate nginx configuration syntax
        run: |
          docker run --rm -v ${{ github.workspace }}/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            nginx:alpine nginx -t

  test-configuration:
    name: Test nginx Configuration Scenarios
    runs-on: ubuntu-latest
    needs: validate-syntax
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up test environment
        run: |
          chmod +x tests/test_nginx_scenarios.sh
          chmod +x tests/mock_backend.py

      - name: Start test services
        run: |
          cd tests
          docker-compose -f docker-compose.test.yml up -d web nginx

          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          for i in {1..30}; do
            if docker-compose -f docker-compose.test.yml ps | grep -q "healthy"; then
              echo "Services are healthy"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Show service status
          docker-compose -f docker-compose.test.yml ps

      - name: Run test scenarios
        run: |
          cd tests
          docker-compose -f docker-compose.test.yml up --abort-on-container-exit test

      - name: Show test logs on failure
        if: failure()
        run: |
          echo "=== nginx logs ==="
          docker-compose -f tests/docker-compose.test.yml logs nginx
          echo ""
          echo "=== backend logs ==="
          docker-compose -f tests/docker-compose.test.yml logs web
          echo ""
          echo "=== test logs ==="
          docker-compose -f tests/docker-compose.test.yml logs test

      - name: Cleanup
        if: always()
        run: |
          cd tests
          docker-compose -f docker-compose.test.yml down -v

  test-summary:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [validate-syntax, test-configuration]
    steps:
      - name: Summary
        run: |
          echo "✅ nginx configuration validation: PASSED"
          echo "✅ Scenario tests: PASSED"
          echo ""
          echo "All nginx configuration tests passed successfully!"
